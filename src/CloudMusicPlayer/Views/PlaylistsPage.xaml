<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CloudMusicPlayer.ViewModels"
             xmlns:models="clr-namespace:CloudMusicPlayer.Models"
             x:Class="CloudMusicPlayer.Views.PlaylistsPage"
             x:DataType="vm:PlaylistsViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="0">
                <!-- Favorites Section -->
                <Grid Padding="15,12" ColumnDefinitions="40,*,Auto" BackgroundColor="Transparent">
                    <Label Grid.Column="0" Text="â™¥" FontSize="24" TextColor="#FF6B6B" VerticalOptions="Center" />
                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Padding="10,0,0,0">
                        <Label Text="Favorites" FontSize="16" FontAttributes="Bold" />
                        <Label Text="{Binding FavoritesCount, StringFormat='{0} tracks'}" FontSize="12" TextColor="Gray" />
                    </VerticalStackLayout>
                    <Label Grid.Column="2" Text="â€º" FontSize="20" TextColor="Gray" VerticalOptions="Center" />
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding OpenFavoritesCommand}" />
                    </Grid.GestureRecognizers>
                </Grid>

                <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#F0F0F0, Dark=#333}" Margin="15,0" />

                <!-- Albums Section -->
                <Label Text="Albums"
                       FontSize="18"
                       FontAttributes="Bold"
                       Margin="15,15,15,5"
                       IsVisible="{Binding HasAlbums}" />
                <ScrollView Orientation="Horizontal"
                            HorizontalScrollBarVisibility="Never"
                            Margin="10,0"
                            IsVisible="{Binding HasAlbums}">
                    <HorizontalStackLayout BindableLayout.ItemsSource="{Binding Albums}" Spacing="0">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:AlbumInfo">
                                <Border StrokeShape="RoundRectangle 10"
                                        StrokeThickness="0"
                                        BackgroundColor="{AppThemeBinding Light=#F8F8FF, Dark=#1A1A2E}"
                                        Padding="8"
                                        Margin="5"
                                        WidthRequest="130">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PlaylistsViewModel}}, Path=OpenAlbumCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    <VerticalStackLayout Spacing="4" InputTransparent="True">
                                        <Border WidthRequest="110" HeightRequest="110"
                                                StrokeShape="RoundRectangle 8"
                                                StrokeThickness="0"
                                                BackgroundColor="{AppThemeBinding Light=#E8E8F0, Dark=#2A2A3E}"
                                                HorizontalOptions="Center"
                                                InputTransparent="True">
                                            <Grid InputTransparent="True">
                                                <Label Text="â™ª" FontSize="40"
                                                       HorizontalOptions="Center" VerticalOptions="Center"
                                                       TextColor="{AppThemeBinding Light=#AAA, Dark=#555}"
                                                       IsVisible="{Binding AlbumArtPath, Converter={StaticResource IsNullConverter}}" />
                                                <Image Source="{Binding AlbumArtPath}"
                                                       Aspect="AspectFill"
                                                       IsVisible="{Binding AlbumArtPath, Converter={StaticResource IsNotNullConverter}}" />
                                            </Grid>
                                        </Border>
                                        <Label Text="{Binding Name}" FontSize="13" FontAttributes="Bold"
                                               LineBreakMode="TailTruncation" MaxLines="1"
                                               HorizontalTextAlignment="Center" />
                                        <Label Text="{Binding Artist}" FontSize="11" TextColor="Gray"
                                               LineBreakMode="TailTruncation" MaxLines="1"
                                               HorizontalTextAlignment="Center" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </HorizontalStackLayout>
                </ScrollView>

                <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#F0F0F0, Dark=#333}" Margin="15,5,15,0"
                         IsVisible="{Binding HasAlbums}" />

                <!-- Playlists -->
                <CollectionView ItemsSource="{Binding Playlists}"
                                 SelectionMode="None"
                                 Margin="0,5,0,0">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="40,20" HorizontalOptions="Center">
                            <Label Text="No playlists yet"
                                   TextColor="Gray"
                                   FontSize="14"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Playlist">
                            <SwipeView>
                                <SwipeView.RightItems>
                                    <SwipeItems>
                                        <SwipeItem Text="Delete"
                                                   BackgroundColor="Red"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PlaylistsViewModel}}, Path=DeletePlaylistCommand}"
                                                   CommandParameter="{Binding .}" />
                                    </SwipeItems>
                                </SwipeView.RightItems>
                                <Grid Padding="15,12" ColumnDefinitions="40,*,Auto" BackgroundColor="Transparent">
                                    <Frame Grid.Column="0" WidthRequest="40" HeightRequest="40"
                                           CornerRadius="5" Padding="0" IsClippedToBounds="True"
                                           BackgroundColor="{StaticResource Primary}">
                                        <Label Text="ðŸŽ¶" FontSize="18" HorizontalOptions="Center" VerticalOptions="Center" TextColor="White" />
                                    </Frame>
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Padding="10,0,0,0">
                                        <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold" />
                                        <Label Text="{Binding TrackCount, StringFormat='{0} tracks'}" FontSize="12" TextColor="Gray" />
                                    </VerticalStackLayout>
                                    <Label Grid.Column="2" Text="â€º" FontSize="20" TextColor="Gray" VerticalOptions="Center" />
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PlaylistsViewModel}}, Path=OpenPlaylistCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Create Playlist Button -->
        <Button Grid.Row="1"
                Text="Create Playlist"
                Command="{Binding CreatePlaylistCommand}"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                Margin="15"
                HeightRequest="50"
                CornerRadius="25" />
    </Grid>
</ContentPage>
